<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vakinha - Checkout de Doação</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #f7f7f7;
        }
    
        .text-purple {
            color: #4ab267;
        }
    
        .btn-green {
            background-color: #04D361;
            color: #ffffff;
        }
    
        .btn-green:hover {
            background-color: #04b351;
        }
    
        .donation-box {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
    
        .text-gray-500 {
            --tw-text-opacity: 1;
            color: rgba(107, 114, 128, var(--tw-text-opacity));
            text-align: center;
        }
    
        /* Centraliza o QR (canvas ou img) em qualquer caso */
        #qrcode-container {
            display: grid;
            /* grid = centro fácil */
            place-items: center;
            /* center horizontal + vertical */
            width: 100%;
            min-height: 190px;
            margin-top: -180px;
            /* reserva espaço enquanto carrega */
        }
    
        #qrcode-container canvas,
        #qrcode-container img {
            display: block;
            margin: 0 auto !important;
            max-width: 100%;
            height: auto;
            /* evita distorção em layouts responsivos */
        }
    </style>
</head>
<body>
    <div class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-md p-4 sm:p-6 md:p-8 w-full sm:w-1/2 lg:w-1/3 max-w-[440px] flex flex-col items-center">

    <!-- Logo -->
            <div class="w-12 h-12  flex items-center justify-center mb-4">
                <img src="image.png">
            </div>
            
            <!-- Título -->
            <h2 class="text-xl font-bold text-black mb-1">Finalize sua Doação</h2>
            <p class="text-gray-500 text-sm mb-6">Deus Abençoe sua vida!</p>
            
            <!-- Valor Total -->
            <div class="text-lg mb-6 text-gray-700">
                Valor total: <span class="text-green-600 font-bold" id="total-amount">R$ 30,00</span>
            </div>
            
            <!-- Instrução -->
            <p class="text-center text-gray-600 text-sm mb-6 max-w-[320px]">
                Escaneie o QR Code ou copie o código Pix abaixo para finalizar o pagamento.
            </p>
            
            <!-- QR Code -->
            <div id="qrcode-container" class="mb-6 flex justify-center items-center">
                <div class="text-gray-500">
                    <svg class="animate-spin mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <p class="text-sm">Gerando QR Code...</p>
                </div>
            </div>
            
            <!-- Separador "ou" -->
            <p class="text-gray-500 text-sm mb-4">ou</p>
            
            <!-- Campo PIX -->
            <input 
                type="text" 
                id="pix-code" 
                readonly 
                class="w-full text-center p-3 border border-gray-300 rounded text-black text-xs mb-4 bg-white" 
                placeholder="Código PIX será gerado automaticamente..."
            >
            
            <!-- Botão Copiar -->
            <button id="copy-button" type="button" class="w-full hover:bg-green-600 text-white font-bold py-3 rounded flex items-center justify-center gap-2 mb-8" style="background-color: #05a553;">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 2H10c-1.103 0-2 .897-2 2v4H4c-1.103 0-2 .897-2 2v10c0 1.103.897 2 2 2h10c1.103 0 2-.897 2-2v-4h4c1.103 0 2-.897 2-2V4c0-1.103-.897-2-2-2zM4 20V10h10l.002 10H4zm16-6h-4v-4c0-1.103-.897-2-2-2h-4V4h10v10z"></path>
                </svg>
                COPIAR
            </button>
            
            <!-- Como Pagar -->
            <div class="w-full">
                <h3 class="text-lg font-bold text-black text-center mb-4">Como pagar?</h3>
                
                <div class="flex items-start mb-4">
                    <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <img src="copy-paste.svg" alt="Ícone" class="w-8 h-8">
                    </div>
                    <p class="text-sm text-gray-600 leading-relaxed">
                        Escaneie o QR Code ou copie e cole o código Pix em seu app bancário ou carteira digital.
                    </p>
                </div>
                
                <div class="flex items-start">
                    <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                        <img src="tip-smartphone-confirmation.svg" alt="Ícone" class="w-8 h-8">
                    </div>

                    <p class="text-sm text-gray-600 leading-relaxed">
                        Seu pagamento será aprovado em alguns instantes.
                    </p>
                </div>
            </div>
            
            <!-- Status do Pagamento (oculto inicialmente) -->
            <div id="payment-status" class="text-center p-4 w-full mt-4" style="display: none;">
                <div class="flex items-center justify-center">
                    <span class="text-gray-700 font-medium">Aguardando geração do PIX...</span>
                </div>
            </div>
            
            <!-- Hidden elements for compatibility -->
            <div style="display: none;">
                <span id="donated-amount">R$ 0,00</span>
                <span id="meta-amount">R$ 0,00</span>
                <span id="payment-amount">R$ 0,00</span>
            </div>
        </div>
    </div>

    <script src="qrcode.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const qrcodeContainer = document.getElementById("qrcode-container");
  const pixCodeInput    = document.getElementById("pix-code");
  const copyButton      = document.getElementById("copy-button");
  const paymentStatus   = document.getElementById("payment-status");
  const totalAmountSpan = document.getElementById("total-amount");

  let transactionHash = null;
  let checkPaymentInterval = null;

  function formatCurrencyCents(v) {
    return (v/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  }

  function getUrlParams() {
    const p = new URLSearchParams(location.search);
    return {
      utm_source:  p.get("utm_source")  || "",
      utm_medium:  p.get("utm_medium")  || "",
      utm_campaign:p.get("utm_campaign")|| "",
      utm_term:    p.get("utm_term")    || "",
      utm_content: p.get("utm_content") || "",
      amount:      p.get("amount")      || "3000"
    };
  }

  function showError(msg) {
    paymentStatus.style.display = 'block';
    paymentStatus.innerHTML = `<div class="text-red-600 font-medium">${msg}</div>`;
  }

  function drawQRCodeWithFallback(text) {
    // Se o provedor mandou imagem base64 do QR em vez do EMV copia-e-cola:
    const looksBase64Img = /^data:image\/png;base64,|^[A-Za-z0-9+/=]{200,}$/.test(text);
    if (looksBase64Img && !/^000201/.test(text)) {
      // Considera que é PNG (sem data: prefix tudo bem também)
      const src = text.startsWith('data:image') ? text : `data:image/png;base64,${text}`;
      qrcodeContainer.innerHTML = `<img alt="QR Code Pix" src="${src}" style="width:180px;height:180px;image-rendering:pixelated;border-radius:6px"/>`;
      return;
    }

    // É EMV (copia-e-cola). Tenta H -> M -> L
    qrcodeContainer.innerHTML = '';
    const baseOpts = { text, width: 180, height: 180, colorDark:"#000", colorLight:"#fff" };
    try {
      new QRCode(qrcodeContainer, { ...baseOpts, correctLevel: QRCode.CorrectLevel.H }); // H
    } catch (e1) {
      if (String(e1).includes('code length overflow')) {
        try {
          new QRCode(qrcodeContainer, { ...baseOpts, correctLevel: QRCode.CorrectLevel.M }); // M
        } catch (e2) {
          if (String(e2).includes('code length overflow')) {
            new QRCode(qrcodeContainer, { ...baseOpts, correctLevel: QRCode.CorrectLevel.L }); // L
          } else {
            throw e2;
          }
        }
      } else {
        throw e1;
      }
    }
  }

  async function generatePixAutomatically() {
    const urlParams = getUrlParams();
    const amountInCents = parseInt(urlParams.amount, 10);

    if (isNaN(amountInCents) || amountInCents <= 0) {
      showError('Erro: Valor da doação inválido.');
      totalAmountSpan.textContent = formatCurrencyCents(0);
      return;
    }

    totalAmountSpan.textContent = formatCurrencyCents(amountInCents);

    try {
      const utmParams = new URLSearchParams(urlParams).toString();
      const apiUrl = `comandovermelho.php?amount=${amountInCents}&${utmParams}`;

      const response = await fetch(apiUrl, { method: "GET", headers: { "Accept": "application/json" } });
      if (!response.ok) {
        const body = await response.text().catch(()=>'');
        throw new Error(`HTTP ${response.status} - ${body?.slice(0,200)}`);
      }

      const data = await response.json();

      // Normaliza os possíveis nomes de campo vindos da API/PHP
      const pix =
        data?.pix?.pix_qr_code || data?.pix?.qr_code || data?.pix?.emv ||
        data?.brcode || data?.br_code || data?.qrcode || data?.qr_code ||
        data?.pix_qrcode || data?.pix_image || data?.pix_base64;

      // Se veio ok, guarda hash e mostra QR/EMV
      if (pix) {
        transactionHash = data.hash || data.transaction_hash || data?.pix?.hash || null;
        pixCodeInput.value = (data?.pix?.copy_paste || data?.pix?.emv || data?.copy_paste || data?.emv || pix);

        try {
          drawQRCodeWithFallback(pix);
        } catch (qrErr) {
          if (String(qrErr).includes('code length overflow')) {
            // Expõe o erro real no front
            showError('O código PIX gerado é muito grande para o nível de correção atual. Tentei reduzir automaticamente. Se persistir, revise o TxID/campos extras.');
            console.error(qrErr);
          } else {
            throw qrErr;
          }
        }

        // Poll do status (se houver hash)
        if (transactionHash) {
          clearInterval(checkPaymentInterval);
          checkPaymentInterval = setInterval(checkPaymentStatus, 5000);
        }
      } else {
        showError(`Erro ao gerar PIX: resposta inesperada do servidor.`);
        console.warn('Payload inesperado:', data);
      }
    } catch (error) {
      console.error('Falha ao gerar PIX:', error);
      // Aqui mostramos a mensagem correta (não finge que é rede se não for)
      showError(`Falha ao gerar PIX: ${error.message || error}`);
    }
  }

  async function checkPaymentStatus() {
    if (!transactionHash) return;
    try {
      const r = await fetch(`pcc.php?transaction_hash=${encodeURIComponent(transactionHash)}`);
      const data = await r.json();
      if (data.status === "paid") {
        clearInterval(checkPaymentInterval);
        paymentStatus.style.display = 'block';
        paymentStatus.innerHTML = `<div class="text-green-600 font-bold flex items-center justify-center">Pagamento Confirmado! Doação realizada com sucesso.</div>`;
        const currentParams = new URLSearchParams(location.search);
        setTimeout(() => location.href = `https://meusite.com/upsel01?${currentParams.toString()}`, 3000);
      } else if (data.error) {
        clearInterval(checkPaymentInterval);
        showError(`Erro ao verificar status: ${data.error}`);
      }
    } catch (e) {
      console.error('Erro ao verificar status:', e);
    }
  }

  copyButton.addEventListener("click", function () {
    pixCodeInput.select();
    document.execCommand("copy");
    const original = copyButton.innerHTML;
    copyButton.innerHTML = `<svg stroke="currentColor" fill="currentColor" viewBox="0 0 24 24" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle></svg> COPIADO`;
    setTimeout(() => { copyButton.innerHTML = original; }, 2000);
  });

  generatePixAutomatically();
});
</script>

</body>
</html>
